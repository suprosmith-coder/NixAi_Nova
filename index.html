<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyanix AI | NixAi</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- ── SEO & Social Preview (Discord, Twitter, Slack, iMessage) ── -->
    <meta name="description" content="High-Intelligence AI with High-Tech Design. Powered by NixAi." />
    <meta name="theme-color" content="#00f0ff">
    <meta name="color-scheme" content="dark">

    <!-- Open Graph (Facebook, Discord, Slack, iMessage, etc.) -->
    <meta property="og:title" content="Cyanix AI" />
    <meta property="og:description" content="High-Intelligence AI with High-Tech Design." />
    <meta property="og:image" content="https://suprosmith-coder.github.io/NixAi_Nova/images/cyanix-preview.png" />
    <meta property="og:image:width" content="1536" />
    <meta property="og:image:height" content="1024" />
    <meta property="og:url" content="https://suprosmith-coder.github.io/NixAi_Nova/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Cyanix AI" />

    <!-- Twitter / X Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Cyanix AI" />
    <meta name="twitter:description" content="High-Intelligence AI with High-Tech Design." />
    <meta name="twitter:image" content="https://suprosmith-coder.github.io/NixAi_Nova/images/cyanix-preview.png" />

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Prism for Code Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>

    <!-- EXIF Reader for Image Orientation -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <style>
        /* ================================================================
           CYBERPUNK VARIABLES
        ================================================================ */
        :root {
            --primary: #00f3ff;
            --primary-dim: rgba(0,243,255,0.15);
            --primary-glow: 0 0 20px rgba(0, 243, 255, 0.7);
            --secondary: #00a8b5;
            --accent: #7d00ff;
            --accent-glow: 0 0 20px rgba(125, 0, 255, 0.5);
            --success: #00ff88;
            --error: #ff4757;
            --warning: #FFD700;
            --background: #050010;
            --surface: #0c0120;
            --surface-light: rgba(21, 21, 32, 0.8);
            --text: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --border: rgba(0, 243, 255, 0.15);
            --glass: rgba(8, 0, 20, 0.92);
            --glass-border: rgba(0, 243, 255, 0.12);
        }

        /* ================================================================
           BASE
        ================================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* ================================================================
           BACKGROUND SYSTEM
        ================================================================ */
        .cyber-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.025) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.025) 1px, transparent 1px);
            background-size: 44px 44px;
            z-index: -3;
            animation: gridMove 40s linear infinite;
        }
        .cyber-scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
            z-index: 9999;
            animation: scanline 5s linear infinite;
            pointer-events: none;
            filter: blur(0.5px);
            opacity: 0.7;
        }
        .floating-particles {
            position: fixed; width: 100%; height: 100%; top: 0; left: 0;
            z-index: -2; overflow: hidden; pointer-events: none;
        }
        .particle {
            position: absolute; width: 2px; height: 2px;
            background: var(--primary); border-radius: 50%;
            animation: particleFloat 15s infinite linear; opacity: 0;
        }
        .glow-orb {
            position: fixed; border-radius: 50%;
            filter: blur(100px); opacity: 0.08; z-index: -1;
            animation: orbFloat 25s infinite ease-in-out;
        }
        .orb-cyan { background: var(--primary); width: 500px; height: 500px; top: 10%; left: 5%; animation-delay: -5s; }
        .orb-purple { background: var(--accent); width: 400px; height: 400px; bottom: 10%; right: 5%; animation: orbFloat 30s infinite ease-in-out reverse; }
        .orb-teal { background: #00ffcc; width: 300px; height: 300px; top: 50%; left: 40%; animation-delay: -10s; opacity: 0.05; }

        /* ================================================================
           AUTH INTERFACE - REDESIGNED
        ================================================================ */
        .auth-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        /* === LEFT PANEL === */
        .auth-left {
            flex: 1.1;
            padding: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Animated hex grid on left panel */
        .auth-left::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse at 30% 30%, rgba(0,243,255,0.06) 0%, transparent 60%),
                radial-gradient(ellipse at 70% 80%, rgba(125,0,255,0.06) 0%, transparent 60%);
            z-index: 0;
        }

        .auth-left-content { position: relative; z-index: 1; }

        /* Neural network canvas */
        #neuralCanvas {
            position: absolute;
            inset: 0;
            opacity: 0.18;
            z-index: 0;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 48px;
            animation: slideInLeft 0.8s cubic-bezier(0.4,0,0.2,1) both;
        }
        .logo-icon {
            width: 52px; height: 52px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--primary-glow), inset 0 1px 0 rgba(255,255,255,0.2);
            animation: iconFloat 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }
        .logo-icon::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.15) 50%, transparent 60%);
            animation: shimmer 3s infinite;
        }
        .logo-text {
            font-size: 26px; font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, var(--primary), #7fffd4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 3px;
        }

        .auth-headline {
            font-size: 52px; font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            line-height: 1.1;
            margin-bottom: 20px;
            animation: slideInLeft 0.8s 0.1s cubic-bezier(0.4,0,0.2,1) both;
        }
        .auth-headline .line1 {
            display: block;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-headline .line2 {
            display: block;
            background: linear-gradient(135deg, var(--primary), #7fffd4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: none;
            filter: drop-shadow(0 0 20px rgba(0,243,255,0.4));
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 50px;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.5px;
            animation: slideInLeft 0.8s 0.2s cubic-bezier(0.4,0,0.2,1) both;
        }
        .auth-subtitle .cursor {
            display: inline-block;
            width: 8px; height: 14px;
            background: var(--primary);
            margin-left: 2px;
            vertical-align: middle;
            animation: blink 1s step-end infinite;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            animation: slideInLeft 0.8s 0.3s cubic-bezier(0.4,0,0.2,1) both;
        }
        .feature-chip {
            padding: 14px 16px;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.08);
            border-radius: 12px;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
            position: relative;
            overflow: hidden;
        }
        .feature-chip::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .feature-chip:hover {
            background: rgba(0,243,255,0.08);
            border-color: rgba(0,243,255,0.2);
            transform: translateX(4px);
        }
        .feature-chip:hover::before { opacity: 1; }
        .feature-icon { color: var(--primary); font-size: 13px; width: 16px; flex-shrink: 0; }
        .feature-text { font-size: 12px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }

        /* STATUS BAR */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 40px;
            padding: 10px 16px;
            background: rgba(0,255,136,0.05);
            border: 1px solid rgba(0,255,136,0.15);
            border-radius: 8px;
            width: fit-content;
            animation: slideInLeft 0.8s 0.4s cubic-bezier(0.4,0,0.2,1) both;
        }
        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }
        .status-text {
            font-size: 11px;
            color: var(--success);
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 1px;
        }

        /* === RIGHT PANEL === */
        .auth-right {
            flex: 0.9;
            background: var(--glass);
            padding: 60px 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-left: 1px solid rgba(0,243,255,0.08);
            position: relative;
            backdrop-filter: blur(30px);
        }

        /* Corner decorations */
        .auth-right::before,
        .auth-right::after {
            content: '';
            position: absolute;
            width: 20px; height: 20px;
            border-color: var(--primary);
            border-style: solid;
            opacity: 0.4;
        }
        .auth-right::before { top: 24px; left: 24px; border-width: 2px 0 0 2px; }
        .auth-right::after { bottom: 24px; right: 24px; border-width: 0 2px 2px 0; }

        /* Corner top-right, bottom-left decorations via pseudo elements */
        .corner-tr, .corner-bl {
            position: absolute;
            width: 20px; height: 20px;
            border-color: var(--primary);
            border-style: solid;
            opacity: 0.4;
        }
        .corner-tr { top: 24px; right: 24px; border-width: 2px 2px 0 0; }
        .corner-bl { bottom: 24px; left: 24px; border-width: 0 0 2px 2px; }

        .auth-form {
            width: 100%;
            max-width: 380px;
            margin: 0 auto;
            animation: slideInRight 0.8s cubic-bezier(0.4,0,0.2,1) both;
        }

        .form-header {
            margin-bottom: 32px;
        }
        .form-header-title {
            font-size: 24px;
            font-weight: 800;
            font-family: 'Orbitron', sans-serif;
            color: var(--text);
            margin-bottom: 6px;
            letter-spacing: 1px;
        }
        .form-header-sub {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* === TABS === */
        .auth-tabs {
            display: flex;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.08);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 32px;
            position: relative;
        }
        .tab-indicator {
            position: absolute;
            top: 4px; left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--primary-glow);
        }
        .tab-indicator.signup { transform: translateX(100%); }
        .auth-tab {
            flex: 1;
            padding: 11px;
            background: transparent; border: none;
            color: var(--text-secondary);
            font-family: 'Orbitron', sans-serif;
            font-size: 12px; font-weight: 700;
            cursor: pointer;
            transition: color 0.3s;
            position: relative; z-index: 1;
            letter-spacing: 1.5px;
        }
        .auth-tab.active { color: var(--background); }

        /* === FORM ELEMENTS === */
        .form-group { margin-bottom: 18px; position: relative; }
        .form-label {
            display: block;
            font-size: 10px; font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 7px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .input-wrapper-inner {
            position: relative;
        }
        .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(0,243,255,0.4);
            font-size: 13px;
            pointer-events: none;
            transition: color 0.3s;
            z-index: 2;
        }
        .form-input {
            width: 100%;
            padding: 13px 14px 13px 40px;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s;
            position: relative;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,243,255,0.08), var(--primary-glow);
            background: rgba(0,243,255,0.07);
        }
        .form-input:focus + .input-icon,
        .input-wrapper-inner:focus-within .input-icon { color: var(--primary); }
        .form-input::placeholder { color: rgba(255,255,255,0.2); }

        /* No icon variant */
        .form-input.no-icon { padding-left: 14px; }

        .password-wrapper { position: relative; }
        .password-toggle {
            position: absolute;
            right: 12px; top: 50%;
            transform: translateY(-50%);
            background: none; border: none;
            color: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: color 0.3s;
            z-index: 3;
            font-size: 13px;
        }
        .password-toggle:hover { color: var(--primary); }

        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
        }
        .checkbox { display: flex; align-items: center; gap: 9px; cursor: pointer; }
        .checkbox input { display: none; }
        .checkbox-box {
            width: 16px; height: 16px;
            border: 2px solid rgba(0,243,255,0.3);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .checkbox input:checked + .checkbox-box {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(0,243,255,0.5);
        }
        .checkbox input:checked + .checkbox-box::after {
            content: '✓';
            position: absolute;
            color: var(--background);
            font-size: 10px;
            font-weight: bold;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .checkbox-label { font-size: 12px; color: var(--text-secondary); }
        .forgot-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s;
            letter-spacing: 0.5px;
        }
        .forgot-link:hover { text-shadow: 0 0 12px var(--primary); }

        /* === AUTH BUTTON === */
        .auth-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 10px;
            color: var(--background);
            font-family: 'Orbitron', sans-serif;
            font-size: 13px; font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .auth-button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .auth-button:hover::before { left: 100%; }
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,243,255,0.4);
        }
        .auth-button:active { transform: translateY(0); }
        .auth-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading spinner */
        .btn-spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(0,0,0,0.3);
            border-top-color: var(--background);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: none;
        }
        .auth-button.loading .btn-icon { display: none; }
        .auth-button.loading .btn-spinner { display: block; }
        .auth-button.loading .btn-text::after { content: '...'; animation: dots 1s infinite; }

        /* === DIVIDER === */
        .divider {
            display: flex;
            align-items: center;
            margin: 22px 0;
            color: var(--text-secondary);
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 2px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0,243,255,0.2), transparent);
        }
        .divider span { padding: 0 16px; }

        /* === SOCIAL BUTTONS === */
        .social-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .social-button {
            padding: 11px;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            display: flex; align-items: center; justify-content: center;
        }
        .social-button:hover {
            background: rgba(0,243,255,0.1);
            border-color: rgba(0,243,255,0.3);
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,243,255,0.1);
        }
        .social-button:active { transform: translateY(0); }

        .auth-footer {
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 18px;
        }
        .auth-footer a {
            color: var(--primary);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 600;
        }
        .auth-footer a:hover { text-shadow: 0 0 10px var(--primary); }

        /* ================================================================
           CHAT INTERFACE
        ================================================================ */
        .chat-container {
            display: none; height: 100vh; position: relative;
        }
        .chat-container.active { display: flex; }

        .sidebar {
            width: 280px; height: 100%;
            background: var(--glass);
            border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 22px 20px;
            border-bottom: 1px solid var(--glass-border);
        }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; }
        .sidebar-logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            box-shadow: var(--primary-glow);
        }
        .sidebar-logo-text {
            font-size: 17px; font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        .sidebar-content { flex: 1; padding: 20px; overflow-y: auto; }
        .new-chat-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none; border-radius: 10px;
            color: var(--background);
            font-family: 'Orbitron', sans-serif;
            font-size: 12px; font-weight: 800;
            cursor: pointer; margin-bottom: 20px;
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            letter-spacing: 1px;
        }
        .new-chat-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,243,255,0.3);
        }
        .sidebar-section { margin-bottom: 25px; }
        .sidebar-title {
            font-size: 10px; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 2px;
            margin-bottom: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        .chat-history { display: flex; flex-direction: column; gap: 6px; }
        .chat-history-item {
            padding: 10px 12px;
            background: rgba(0,243,255,0.04);
            border: 1px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; align-items: center; gap: 10px;
        }
        .chat-history-item:hover {
            background: rgba(0,243,255,0.08);
            border-color: rgba(0,243,255,0.15);
        }
        .chat-history-item.active {
            background: rgba(0,243,255,0.12);
            border-color: var(--primary);
        }
        .chat-history-icon { color: var(--primary); font-size: 11px; }
        .chat-history-text {
            font-size: 12px; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;
        }
        .chat-history-item .delete-chat-btn {
            background: none; border: none;
            color: rgba(255,255,255,0.2); font-size: 10px;
            cursor: pointer; padding: 2px 4px;
            border-radius: 4px; transition: all 0.2s;
            opacity: 0; flex-shrink: 0;
        }
        .chat-history-item:hover .delete-chat-btn { opacity: 1; }
        .chat-history-item .delete-chat-btn:hover { color: var(--error); background: rgba(255,71,87,0.1); }
        .chat-history-empty {
            padding: 16px 8px; text-align: center;
            color: var(--text-secondary); font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            border: 1px dashed rgba(0,243,255,0.1);
            border-radius: 8px; line-height: 1.6;
        }
        .sidebar-actions { display: flex; flex-direction: column; gap: 6px; }
        .sidebar-action {
            padding: 10px 12px;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.08);
            border-radius: 8px;
            color: var(--text); font-size: 13px;
            cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 10px;
        }
        .sidebar-action:hover {
            background: rgba(0,243,255,0.08);
            transform: translateX(4px);
        }
        .sidebar-action-icon { color: var(--primary); font-size: 12px; }
        .sidebar-footer {
            padding: 18px 20px;
            border-top: 1px solid var(--glass-border);
        }
        .user-profile {
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: all 0.3s;
        }
        .user-profile:hover { transform: translateY(-2px); }
        .user-avatar {
            width: 38px; height: 38px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; color: var(--background); font-size: 14px;
            box-shadow: var(--primary-glow);
            overflow: hidden; flex-shrink: 0;
        }
        .user-avatar img {
            width: 100%; height: 100%;
            object-fit: cover; border-radius: 50%;
        }
        .message-avatar img {
            width: 100%; height: 100%;
            object-fit: cover; border-radius: 50%;
        }
        .user-info { flex: 1; min-width: 0; }
        .user-name {
            font-size: 13px; font-weight: 600; color: var(--text);
            margin-bottom: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .user-email {
            font-size: 10px; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Main Chat */
        .main-chat { flex: 1; display: flex; flex-direction: column; background: var(--background); }
        .chat-header {
            padding: 18px 24px;
            background: var(--glass);
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 100;
        }
        .chat-title {
            font-size: 16px; font-weight: 700;
            color: var(--text);
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }
        .model-badge {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 14px;
            background: rgba(0,243,255,0.08);
            border: 1px solid rgba(0,243,255,0.2);
            border-radius: 20px;
            font-size: 12px; color: var(--primary);
            cursor: pointer; transition: all 0.3s;
            font-family: 'JetBrains Mono', monospace;
        }
        .model-badge:hover { background: rgba(0,243,255,0.15); }
        .chat-actions { display: flex; gap: 8px; }
        .header-action {
            padding: 7px 12px;
            background: rgba(0,243,255,0.05);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 8px;
            color: var(--primary); font-size: 12px;
            cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 6px;
        }
        .header-action:hover {
            background: rgba(0,243,255,0.1);
            transform: translateY(-2px);
        }

        .messages-container {
            flex: 1; overflow-y: auto;
            padding: 30px;
            background: var(--background);
        }
        .messages-wrapper {
            max-width: 800px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 25px;
        }

        /* Welcome Screen */
        .welcome-screen {
            max-width: 680px; margin: 0 auto;
            text-align: center;
            padding: 60px 20px;
        }
        .welcome-icon {
            font-size: 64px; margin-bottom: 28px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: iconFloat 3s ease-in-out infinite;
        }
        .welcome-title {
            font-size: 40px; font-weight: 900;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--text));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 18px; letter-spacing: 3px;
        }
        .welcome-subtitle {
            font-size: 14px; color: var(--text-secondary);
            max-width: 480px; margin: 0 auto 40px;
            line-height: 1.7;
            font-family: 'JetBrains Mono', monospace;
        }
        .example-grid {
            display: grid; grid-template-columns: repeat(2,1fr);
            gap: 14px; max-width: 500px; margin: 0 auto;
        }
        .example-card {
            padding: 20px;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 12px;
            text-align: left; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        .example-card:hover {
            background: rgba(0,243,255,0.08);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,243,255,0.08);
            border-color: rgba(0,243,255,0.25);
        }
        .example-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .example-icon { color: var(--primary); font-size: 13px; }
        .example-title { font-size: 13px; font-weight: 600; color: var(--primary); font-family: 'Orbitron', sans-serif; }
        .example-text { font-size: 12px; color: var(--text-secondary); line-height: 1.5; }

        /* Messages */
        .message { max-width: 85%; animation: messageSlide 0.4s cubic-bezier(0.4,0,0.2,1); }
        .message.user { align-self: flex-end; }
        .message.assistant { align-self: flex-start; }
        .message-bubble {
            padding: 18px 20px; border-radius: 16px;
            position: relative; overflow: hidden;
        }
        .message.user .message-bubble {
            background: linear-gradient(135deg, rgba(0,243,255,0.1), rgba(0,168,181,0.05));
            border: 1px solid rgba(0,243,255,0.2);
            border-bottom-right-radius: 4px;
        }
        .message.assistant .message-bubble {
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.1);
            border-bottom-left-radius: 4px;
        }
        .message-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .message-avatar {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 12px; flex-shrink: 0;
        }
        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--background);
        }
        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--accent), #9d4edd);
            color: var(--text);
        }
        .message-sender { font-size: 13px; font-weight: 600; color: var(--text); }
        .message-time { font-size: 10px; color: var(--text-secondary); margin-left: auto; }
        .message-content { font-size: 14px; line-height: 1.7; color: var(--text); }
        .message-content.streaming::after {
            content: '▋';
            display: inline-block;
            color: var(--primary);
            animation: blink 0.7s step-end infinite;
            margin-left: 1px;
        }
        .message-content p { margin-bottom: 10px; }
        .message-content pre {
            background: rgba(0,0,0,0.3); padding: 15px;
            border-radius: 10px; overflow-x: auto; margin: 10px 0;
            border: 1px solid rgba(0,243,255,0.1);
        }
        .message-content code { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .message-content img { max-width: 100%; border-radius: 10px; margin: 10px 0; }

        /* Attachments */
        .attachments-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }
        .attachment-item {
            position: relative;
            background: rgba(0,243,255,0.05);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 8px; padding: 10px;
            max-width: 200px; cursor: pointer; transition: all 0.3s;
        }
        .attachment-item:hover { background: rgba(0,243,255,0.1); }
        .attachment-preview { position: relative; overflow: hidden; border-radius: 6px; margin-bottom: 8px; background: rgba(0,0,0,0.2); }
        .attachment-preview img { width: 100%; height: auto; max-height: 150px; object-fit: cover; display: block; }
        .attachment-icon { width: 100%; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary); }
        .attachment-info { padding: 5px; }
        .attachment-name { font-size: 12px; color: var(--text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .attachment-size { font-size: 10px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
        .attachment-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .attachment-action {
            width: 24px; height: 24px;
            background: rgba(0,0,0,0.7); border: none;
            border-radius: 4px; color: var(--text); font-size: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .attachment-action:hover { background: rgba(0,243,255,0.5); }

        /* File Preview Modal */
        .file-preview-modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center;
            z-index: 10001; backdrop-filter: blur(10px);
        }
        .file-preview-modal.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .file-preview-content {
            max-width: 90vw; max-height: 90vh;
            background: var(--glass); border-radius: 20px;
            overflow: hidden; position: relative;
            border: 1px solid var(--glass-border);
        }
        .file-preview-image { max-width: 100%; max-height: 80vh; object-fit: contain; display: block; }
        .file-preview-iframe { width: 800px; height: 600px; border: none; background: white; }
        .file-preview-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }

        /* Input Area */
        .input-container {
            padding: 18px 24px;
            background: var(--glass); border-top: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            position: sticky; bottom: 0;
        }
        .input-wrapper { max-width: 800px; margin: 0 auto; position: relative; }
        .selected-files-preview {
            display: flex; flex-wrap: wrap; gap: 8px;
            margin-bottom: 10px; padding: 10px;
            background: rgba(0,243,255,0.04); border-radius: 8px;
            border: 1px solid rgba(0,243,255,0.1);
            max-height: 150px; overflow-y: auto;
        }
        .selected-file {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 10px;
            background: rgba(0,243,255,0.08); border-radius: 6px;
            font-size: 12px; max-width: 200px;
        }
        .selected-file-icon { color: var(--primary); font-size: 12px; }
        .selected-file-info { flex: 1; min-width: 0; }
        .selected-file-name { color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .selected-file-size { color: var(--text-secondary); font-size: 10px; font-family: 'JetBrains Mono', monospace; }
        .selected-file-remove { background: none; border: none; color: var(--error); cursor: pointer; font-size: 10px; transition: all 0.3s; }
        .selected-file-remove:hover { transform: scale(1.2); }
        .chat-input {
            width: 100%; min-height: 56px; max-height: 200px;
            padding: 16px 120px 16px 20px;
            background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 12px; color: var(--text);
            font-size: 14px; font-family: 'Inter', sans-serif;
            resize: none; transition: all 0.3s; line-height: 1.5;
        }
        .chat-input:focus {
            outline: none; border-color: var(--primary);
            box-shadow: var(--primary-glow);
            background: rgba(0,243,255,0.07);
        }
        .chat-input::placeholder { color: rgba(255,255,255,0.25); }
        .input-actions { position: absolute; right: 12px; bottom: 12px; display: flex; gap: 8px; align-items: center; }
        .input-button {
            width: 38px; height: 38px;
            background: rgba(0,243,255,0.08);
            border: 1px solid rgba(0,243,255,0.15);
            border-radius: 50%; color: var(--primary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.3s;
        }
        .input-button:hover { background: rgba(0,243,255,0.18); transform: scale(1.1); }
        .input-button.send {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--background); box-shadow: var(--primary-glow);
        }
        .input-button.send:hover { transform: scale(1.1) rotate(10deg); }
        .char-count { font-size: 10px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }

        /* Upload progress */
        .upload-progress { width: 100%; height: 4px; background: rgba(0,243,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 5px; }
        .upload-progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: width 0.3s ease; }

        /* Typing Indicator */
        .typing-indicator {
            display: flex; align-items: center; gap: 10px;
            padding: 14px; background: rgba(0,243,255,0.04);
            border: 1px solid rgba(0,243,255,0.1);
            border-radius: 12px; max-width: 120px; margin-bottom: 10px;
        }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--primary);
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.8);
            display: none; justify-content: center; align-items: center;
            z-index: 10000; backdrop-filter: blur(10px);
        }
        .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease-out; }
        .modal {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 30px;
            width: 90%; max-width: 500px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            position: relative;
            animation: modalSlide 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        .modal-title { font-size: 18px; font-weight: 700; color: var(--text); font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 22px; cursor: pointer; transition: all 0.3s; }
        .modal-close:hover { color: var(--primary); }
        .modal-content { max-height: 60vh; overflow-y: auto; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--glass-border); }
        .modal-button { padding: 10px 20px; border: none; border-radius: 8px; font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; letter-spacing: 1px; }
        .modal-button.primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--background); }
        .modal-button.secondary { background: rgba(0,243,255,0.08); color: var(--primary); border: 1px solid rgba(0,243,255,0.2); }
        .modal-button:hover { transform: translateY(-2px); }
        .model-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; margin-bottom: 20px; }
        .model-card { padding: 18px; background: rgba(0,243,255,0.04); border: 1px solid rgba(0,243,255,0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .model-card:hover { background: rgba(0,243,255,0.08); transform: translateY(-3px); }
        .model-card.active { background: rgba(0,243,255,0.12); border-color: var(--primary); box-shadow: var(--primary-glow); }
        .model-icon { font-size: 22px; color: var(--primary); margin-bottom: 8px; }
        .model-name { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; font-family: 'Orbitron', sans-serif; }
        .model-desc { font-size: 11px; color: var(--text-secondary); }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 330px; }
        .toast {
            padding: 14px 16px; background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 12px; color: var(--text); backdrop-filter: blur(10px);
            transform: translateX(110%); animation: toastSlide 0.35s forwards;
            display: flex; align-items: flex-start; gap: 12px;
        }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--primary); }
        .toast.warning { border-left: 3px solid var(--warning); }
        .toast-icon { font-size: 15px; margin-top: 1px; }
        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--error); }
        .toast.info .toast-icon { color: var(--primary); }
        .toast.warning .toast-icon { color: var(--warning); }
        .toast-content { flex: 1; }
        .toast-message { font-size: 13px; color: var(--text); line-height: 1.4; }
        .toast-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; transition: color 0.3s; }
        .toast-close:hover { color: var(--primary); }

        /* Mobile Menu Button */
        .mobile-menu-button {
            display: none; position: fixed; top: 18px; left: 18px;
            width: 42px; height: 42px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none; border-radius: 10px;
            color: var(--background); font-size: 16px;
            cursor: pointer; z-index: 1001;
            box-shadow: var(--primary-glow); transition: all 0.3s;
        }
        .mobile-menu-button:hover { transform: scale(1.1); }

        /* ================================================================
           ANIMATIONS
        ================================================================ */
        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 44px 44px; }
        }
        @keyframes scanline {
            0% { transform: translateX(-100%); opacity: 0; }
            5% { opacity: 0.7; }
            95% { opacity: 0.7; }
            100% { transform: translateX(100vw); opacity: 0; }
        }
        @keyframes particleFloat {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 0.4; }
            90% { opacity: 0.4; }
            100% { transform: translateY(-100px) translateX(80px); opacity: 0; }
        }
        @keyframes orbFloat {
            0%, 100% { transform: translate(0,0) scale(1); }
            33% { transform: translate(40px,-25px) scale(1.08); }
            66% { transform: translate(-25px,18px) scale(0.94); }
        }
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 8px var(--success); opacity: 1; }
            50% { box-shadow: 0 0 16px var(--success); opacity: 0.7; }
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-24px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toastSlide {
            to { transform: translateX(0); }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-7px); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes formAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes glitch {
            0%, 100% { clip-path: inset(0 0 100% 0); }
            10% { clip-path: inset(10% 0 80% 0); transform: translate(-2px, 0); }
            20% { clip-path: inset(40% 0 50% 0); transform: translate(2px, 0); }
            30% { clip-path: inset(70% 0 20% 0); transform: translate(0, 0); }
        }

        /* ================================================================
           RESPONSIVE
        ================================================================ */
        @media (max-width: 1024px) {
            .auth-headline { font-size: 40px; }
            .sidebar { width: 250px; }
        }
        @media (max-width: 768px) {
            .auth-container { flex-direction: column; }
            .auth-left { padding: 40px 24px; }
            .auth-right { padding: 40px 24px; flex: none; }
            .auth-headline { font-size: 34px; }
            .sidebar {
                position: fixed; left: -280px; top: 0;
                height: 100%; z-index: 1000;
                transition: transform 0.3s;
            }
            .sidebar.active { transform: translateX(280px); }
            .mobile-menu-button { display: flex; align-items: center; justify-content: center; }
            .chat-actions { display: none; }
            .example-grid { grid-template-columns: 1fr; }
            .model-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .auth-headline { font-size: 28px; }
            .welcome-title { font-size: 28px; }
            .message { max-width: 95%; }
            .social-buttons { grid-template-columns: repeat(2,1fr); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,243,255,0.03); }
        ::-webkit-scrollbar-thumb { background: rgba(0,243,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,243,255,0.25); }
        ::selection { background: var(--primary); color: var(--background); }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="cyber-grid"></div>
    <div class="cyber-scanline"></div>
    <div class="floating-particles" id="particles"></div>
    <div class="glow-orb orb-cyan"></div>
    <div class="glow-orb orb-purple"></div>
    <div class="glow-orb orb-teal"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- File Preview Modal -->
    <div id="filePreviewModal" class="file-preview-modal">
        <div class="file-preview-content">
            <div class="file-preview-actions">
                <button class="input-button" onclick="downloadPreviewFile()" title="Download">
                    <i class="fas fa-download"></i>
                </button>
                <button class="input-button" onclick="closeFilePreview()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <img id="previewImage" class="file-preview-image" src="" alt="Preview">
            <iframe id="previewIframe" class="file-preview-iframe" style="display:none;"></iframe>
            <div id="previewText" style="display:none; padding:30px; color:var(--text); font-family:'JetBrains Mono',monospace; max-height:80vh; overflow-y:auto; white-space:pre-wrap;"></div>
        </div>
    </div>

    <!-- Model Modal -->
    <div id="modelModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select AI Model</h3>
                <button class="modal-close" onclick="closeModelModal()">&times;</button>
            </div>
            <div class="modal-content">
                <p style="color:var(--text-secondary); margin-bottom:20px; font-size:13px; font-family:'JetBrains Mono',monospace;">
                    Choose the AI model that best suits your needs.
                </p>
                <div class="model-grid" id="modelGrid">
                    <div class="model-card active" data-model="cyanix-pro" onclick="selectModel('cyanix-pro')">
                        <div class="model-icon"><i class="fas fa-brain"></i></div>
                        <div class="model-name">Axion</div>
                        <div class="model-desc">Most capable for complex reasoning</div>
                    </div>
                    <div class="model-card" data-model="cyanix-flash" onclick="selectModel('cyanix-flash')">
                        <div class="model-icon"><i class="fas fa-bolt"></i></div>
                        <div class="model-name">Cyanix</div>
                        <div class="model-desc">Fast responses for everyday tasks</div>
                    </div>
                    <div class="model-card" data-model="cyanix-vision" onclick="selectModel('cyanix-vision')">
                        <div class="model-icon"><i class="fas fa-eye"></i></div>
                        <div class="model-name">Synix</div>
                        <div class="model-desc">Image analysis and description</div>
                    </div>
                    <div class="model-card" data-model="cyanix-advanced" onclick="selectModel('cyanix-advanced')">
                        <div class="model-icon"><i class="fas fa-robot"></i></div>
                        <div class="model-name">Nebula</div>
                        <div class="model-desc">Expert model for specialized tasks</div>
                    </div>
                </div>
                <div style="background:rgba(0,243,255,0.04); padding:14px; border-radius:10px; border:1px solid rgba(0,243,255,0.1);">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <i class="fas fa-info-circle" style="color:var(--primary);"></i>
                        <span style="color:var(--text); font-weight:600; font-size:13px;">Model Information</span>
                    </div>
                    <div style="color:var(--text-secondary); font-size:12px; line-height:1.5; font-family:'JetBrains Mono',monospace;">
                        All models are powered by Llama.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" onclick="closeModelModal()">Cancel</button>
                <button class="modal-button primary" onclick="saveModelSelection()">Select Model</button>
            </div>
        </div>
    </div>

    <!-- File Modal -->
    <div id="fileModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Attach Files</h3>
                <button class="modal-close" onclick="closeFileModal()">&times;</button>
            </div>
            <div class="modal-content">
                <div class="drop-zone" id="dropZone"
                     style="text-align:center; padding:40px; border:2px dashed rgba(0,243,255,0.25); border-radius:12px; margin-bottom:20px; cursor:pointer; transition:all 0.3s;">
                    <i class="fas fa-cloud-upload-alt" style="font-size:42px; color:var(--primary); margin-bottom:15px; display:block;"></i>
                    <div style="color:var(--text); font-weight:600; margin-bottom:8px;">Drag & Drop Files Here</div>
                    <div style="color:var(--text-secondary); font-size:12px; margin-bottom:20px;">or click to browse files</div>
                    <div style="font-size:11px; color:var(--text-secondary); margin-bottom:14px; font-family:'JetBrains Mono',monospace;">
                        Images, PDF, DOC, DOCX, XLS, TXT, ZIP, and more
                    </div>
                    <button class="modal-button primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                    <input type="file" id="fileInput" multiple style="display:none;"
                           accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z,.js,.py,.html,.css,.json,.xml,.csv,.mp3,.mp4,.wav,.mov,.avi,.mkv">
                </div>
                <div id="selectedFiles"></div>
                <div id="uploadProgress" style="display:none;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="color:var(--text); font-size:12px;">Uploading...</span>
                        <span id="uploadPercentage" style="color:var(--primary); font-size:12px;">0%</span>
                    </div>
                    <div class="upload-progress"><div class="upload-progress-bar" id="uploadProgressBar"></div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" onclick="closeFileModal()">Cancel</button>
                <button class="modal-button primary" onclick="uploadFiles()">
                    <i class="fas fa-upload"></i> Upload Files
                </button>
            </div>
        </div>
    </div>

    <!-- ================================================================
         AUTH INTERFACE
    ================================================================ -->
    <div id="authContainer" class="auth-container">

        <!-- LEFT: Brand Panel -->
        <div class="auth-left">
            <canvas id="neuralCanvas"></canvas>
            <div class="auth-left-content">
                <div class="auth-logo">
                    <div class="logo-icon">
                        <img src="cyanix_logo.png" alt="Cyanix Logo" style="width:100%; height:100%; object-fit:contain;">
                    </div>
                    <div class="logo-text">CYANIX AI</div>
                </div>

                <h1 class="auth-headline">
                    <span class="line1">POWERED BY</span>
                    <span class="line2">NixAi</span>
                </h1>

                <p class="auth-subtitle">
                    <span id="typewriterText"></span><span class="cursor"></span>
                </p>

                <div class="feature-grid">
                    <div class="feature-chip">
                        <i class="fas fa-bolt feature-icon"></i>
                        <span class="feature-text">Instant Access</span>
                    </div>
                    <div class="feature-chip">
                        <i class="fas fa-shield-alt feature-icon"></i>
                        <span class="feature-text">End-to-End Encryption</span>
                    </div>
                    <div class="feature-chip">
                        <i class="fas fa-brain feature-icon"></i>
                        <span class="feature-text">Multiple AI Models</span>
                    </div>
                    <div class="feature-chip">
                        <i class="fas fa-file-export feature-icon"></i>
                        <span class="feature-text">Export Conversations</span>
                    </div>
                    <div class="feature-chip">
                        <i class="fas fa-paperclip feature-icon"></i>
                        <span class="feature-text">File Attachments</span>
                    </div>
                    <div class="feature-chip">
                        <i class="fas fa-history feature-icon"></i>
                        <span class="feature-text">Unlimited History</span>
                    </div>
                </div>

                <div class="status-bar">
                    <div class="status-dot"></div>
                    <span class="status-text">ALL SYSTEMS OPERATIONAL</span>
                </div>
            </div>
        </div>

        <!-- RIGHT: Auth Form Panel -->
        <div class="auth-right">
            <div class="corner-tr"></div>
            <div class="corner-bl"></div>

            <div class="auth-form">
                <div class="form-header">
                    <div class="form-header-title" id="formHeaderTitle">NEURAL ACCESS</div>
                    <div class="form-header-sub" id="formHeaderSub">// authenticate to continue_</div>
                </div>

                <div class="auth-tabs">
                    <div class="tab-indicator" id="tabIndicator"></div>
                    <button class="auth-tab active" id="signinTab" onclick="switchAuthTab('signin')">SIGN IN</button>
                    <button class="auth-tab" id="signupTab" onclick="switchAuthTab('signup')">SIGN UP</button>
                </div>

                <!-- ── SIGN IN FORM ── -->
                <div id="signinForm" style="animation: formAppear 0.3s ease-out both;">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="input-wrapper-inner">
                            <i class="fas fa-at input-icon"></i>
                            <input type="email" id="signinEmail" class="form-input" placeholder="you@example.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div class="input-wrapper-inner password-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signinPassword" class="form-input" placeholder="••••••••"
                                   onkeydown="if(event.key==='Enter') signInWithEmail()">
                            <button class="password-toggle" type="button" onclick="togglePassword('signinPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-options">
                        <label class="checkbox">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkbox-box"></span>
                            <span class="checkbox-label">Remember me</span>
                        </label>
                        <a href="#" class="forgot-link" onclick="forgotPassword(); return false;">Forgot password?</a>
                    </div>

                    <button class="auth-button" id="signinBtn" onclick="signInWithEmail()">
                        <span class="btn-icon"><i class="fas fa-sign-in-alt"></i></span>
                        <span class="btn-text">SIGN IN</span>
                        <div class="btn-spinner"></div>
                    </button>

                    <div class="divider"><span>OR CONTINUE WITH</span></div>

                    <div class="social-buttons">
                        <button class="social-button" onclick="signInWithGoogle()" title="Google">
                            <i class="fab fa-google"></i>
                        </button>
                        <button class="social-button" onclick="signInWithMicrosoft()" title="Microsoft">
                            <i class="fab fa-microsoft"></i>
                        </button>
                        <button class="social-button" onclick="signInWithGithub()" title="GitHub">
                            <i class="fab fa-github"></i>
                        </button>
                        <button class="social-button" onclick="signInWithDiscord()" title="Discord">
                            <i class="fab fa-discord"></i>
                        </button>
                    </div>

                    <p class="auth-footer">
                        Don't have an account? <a href="#" onclick="switchAuthTab('signup'); return false;">Sign Up</a>
                    </p>
                </div>

                <!-- ── SIGN UP FORM ── -->
                <div id="signupForm" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <div class="input-wrapper-inner">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="signupName" class="form-input" placeholder="Your full name">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <div class="input-wrapper-inner">
                            <i class="fas fa-at input-icon"></i>
                            <input type="email" id="signupEmail" class="form-input" placeholder="you@example.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <div class="input-wrapper-inner password-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signupPassword" class="form-input" placeholder="Min. 6 characters">
                            <button class="password-toggle" type="button" onclick="togglePassword('signupPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <div class="input-wrapper-inner password-wrapper">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm password">
                            <button class="password-toggle" type="button" onclick="togglePassword('signupConfirmPassword')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox">
                            <input type="checkbox" id="acceptTerms">
                            <span class="checkbox-box"></span>
                            <span class="checkbox-label">I agree to the Terms & Privacy Policy</span>
                        </label>
                    </div>

                    <button class="auth-button" id="signupBtn" onclick="signUpWithEmail()">
                        <span class="btn-icon"><i class="fas fa-user-plus"></i></span>
                        <span class="btn-text">CREATE ACCOUNT</span>
                        <div class="btn-spinner"></div>
                    </button>

                    <div class="divider"><span>OR SIGN UP WITH</span></div>

                    <div class="social-buttons">
                        <button class="social-button" onclick="signUpWithGoogle()" title="Google">
                            <i class="fab fa-google"></i>
                        </button>
                        <button class="social-button" onclick="signUpWithMicrosoft()" title="Microsoft">
                            <i class="fab fa-microsoft"></i>
                        </button>
                        <button class="social-button" onclick="signUpWithGithub()" title="GitHub">
                            <i class="fab fa-github"></i>
                        </button>
                        <button class="social-button" onclick="signUpWithDiscord()" title="Discord">
                            <i class="fab fa-discord"></i>
                        </button>
                    </div>

                    <p class="auth-footer">
                        Already have an account? <a href="#" onclick="switchAuthTab('signin'); return false;">Sign In</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================
         CHAT INTERFACE
    ================================================================ -->
    <div id="chatContainer" class="chat-container">
        <button class="mobile-menu-button" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <img src="cyanix_logo.png" alt="Cyanix Logo" style="width:100%; height:100%; object-fit:contain;">
                    </div>
                    <div class="sidebar-logo-text">CYANIX AI</div>
                </div>
            </div>

            <div class="sidebar-content">
                <button class="new-chat-button" onclick="newChat()">
                    <i class="fas fa-plus"></i> NEW CHAT
                </button>

                <div class="sidebar-section">
                    <div class="sidebar-title">RECENT CHATS</div>
                    <div class="chat-history" id="chatHistory">
                        <div class="chat-history-empty">
                            Sign in to see<br>your chat history
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">ACTIONS</div>
                    <div class="sidebar-actions">
                        <button class="sidebar-action" onclick="openModelModal()">
                            <i class="fas fa-brain sidebar-action-icon"></i>
                            <span>Change AI Model</span>
                        </button>
                        <button class="sidebar-action" onclick="clearChat()">
                            <i class="fas fa-trash sidebar-action-icon"></i>
                            <span>Clear Chat</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile" onclick="toggleUserMenu()" id="userProfile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">User</div>
                        <div class="user-email" id="userEmail">user@example.com</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-chat">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:14px;">
                    <div class="chat-title" id="chatTitle">New Chat</div>
                    <div class="model-badge" onclick="openModelModal()">
                        <i class="fas fa-brain"></i>
                        <span id="currentModel">Axion</span>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="header-action" onclick="openModelModal()">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="messages-wrapper" id="messagesWrapper">
                    <!-- Welcome screen rendered by JS -->
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <div id="selectedFilesPreview" class="selected-files-preview" style="display:none;"></div>
                    <div style="position:relative;">
                        <textarea
                            id="chatInput"
                            class="chat-input"
                            placeholder="Message Cyanix AI..."
                            rows="1"
                            oninput="autoResize(this)"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <div class="input-actions">
                            <span class="char-count" id="charCount">0/2000</span>
                            <button class="input-button" onclick="openFileModal()" title="Attach Files">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-button send" onclick="sendMessage()" title="Send Message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================================================
         WELCOME SCREEN TEMPLATE (hidden, cloned into chat on demand)
    ================================================================ -->
    <template id="welcomeScreenTemplate">
        <div class="welcome-screen">
            <div class="welcome-icon">
                <img src="cyanix_logo.png" alt="Cyanix Logo" style="width:64px; height:64px; object-fit:contain;">
            </div>
            <h1 class="welcome-title">CYANIX AI</h1>
            <p class="welcome-subtitle">
                Advanced neural interface for intelligent conversations.
                No API keys required — powered by state-of-the-art AI infrastructure.
            </p>
            <div class="example-grid">
                <div class="example-card" onclick="useExample('brainstorm')">
                    <div class="example-header">
                        <i class="fas fa-lightbulb example-icon"></i>
                        <div class="example-title">Brainstorm Ideas</div>
                    </div>
                    <div class="example-text">"Help me brainstorm creative project ideas for a tech startup"</div>
                </div>
                <div class="example-card" onclick="useExample('explain')">
                    <div class="example-header">
                        <i class="fas fa-book example-icon"></i>
                        <div class="example-title">Explain Concepts</div>
                    </div>
                    <div class="example-text">"Explain quantum computing in simple terms"</div>
                </div>
                <div class="example-card" onclick="useExample('code')">
                    <div class="example-header">
                        <i class="fas fa-code example-icon"></i>
                        <div class="example-title">Write Code</div>
                    </div>
                    <div class="example-text">"Write a Python function to sort a list using quicksort"</div>
                </div>
                <div class="example-card" onclick="useExample('analyze')">
                    <div class="example-header">
                        <i class="fas fa-chart-line example-icon"></i>
                        <div class="example-title">Analyze Data</div>
                    </div>
                    <div class="example-text">"Analyze the pros and cons of renewable energy sources"</div>
                </div>
            </div>
        </div>
    </template>

    <script>
    /* ================================================================
       SUPABASE CONFIGURATION
       NOTE: supabase client is initialized INSIDE DOMContentLoaded so
       that the CDN script is guaranteed to be parsed first. Initializing
       it at the top level causes a silent TypeError if the CDN hasn't
       loaded yet, which kills ALL subsequent function definitions and
       makes every button completely unresponsive.
    ================================================================ */
    const SUPABASE_URL          = 'https://tdbgpvscwaysndrloltl.supabase.co';
    const SUPABASE_ANON_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkYmdwdnNjd2F5c25kcmxvbHRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDExMTQsImV4cCI6MjA4NTMxNzExNH0.5-UfXEYo8qbjmHPhuZdj4Yf3wqjEOtre4zQgDhDJShw';
    const SUPABASE_FUNCTION_URL = 'https://tdbgpvscwaysndrloltl.supabase.co/functions/v1/chat';

    // ── Supabase client ──
    // Declared here so all functions can reference it.
    // Assigned inside DOMContentLoaded so the CDN script is guaranteed loaded.
    let supabaseClient = null;

    /* ================================================================
       MODEL MAPPING
    ================================================================ */
    const MODEL_MAP = {
        'cyanix-pro':      'llama-3.3-70b-versatile',
        'cyanix-flash':    'llama-3.1-8b-instant',
        'cyanix-vision':   'llama-3.2-11b-vision-preview',
        'cyanix-advanced': 'llama-3.1-70b-versatile'
    };

    /* ================================================================
       APP STATE
    ================================================================ */
    let currentUser        = null;
    let currentChatId      = null;
    let currentModel       = 'cyanix-pro';
    let conversationHistory = [];
    let attachedFiles      = [];
    let selectedFiles      = [];

    /* ================================================================
       INITIALIZATION
    ================================================================ */
    document.addEventListener('DOMContentLoaded', () => {

        // ── Safe Supabase v2 CDN init ──────────────────────────────────────
        // CDN scripts loaded in <head> are guaranteed parsed before any
        // DOMContentLoaded callback runs, so this is always safe here.
        try {
            const { createClient } = window.supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error('[Cyanix] Supabase failed to initialize:', e);
            // Show error banner so user knows to refresh, not silently break
            const banner = document.createElement('div');
            banner.style.cssText = 'position:fixed;top:0;left:0;right:0;padding:12px;background:#ff4757;color:#fff;text-align:center;z-index:9999;font-family:monospace;font-size:13px;';
            banner.textContent = '⚠ Connection error — please refresh the page.';
            document.body.appendChild(banner);
            return; // stop init — nothing will work without Supabase
        }

        initializeBackground();
        initializeNeuralCanvas();
        initializeTypewriter();
        initializeAuth();
        setupEventListeners();
        initializeFileDropZone();
        renderWelcomeScreen();

        if (typeof marked !== 'undefined') {
            marked.setOptions({
                highlight(code, lang) {
                    if (typeof Prism !== 'undefined' && Prism.languages[lang])
                        return Prism.highlight(code, Prism.languages[lang], lang);
                    return code;
                },
                breaks: true,
                gfm: true
            });
        }

        // NOTE: showAuth() is no longer called here unconditionally.
        // initializeAuth() calls getSession() above — if there IS a session
        // (e.g. returning from OAuth redirect) it calls showChat() directly.
        // If there is NO session, we show the auth screen.
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (!session) showAuth();
        });
    });

    /* -- Background particles -- */
    function initializeBackground() {
        const container = document.getElementById('particles');
        for (let i = 0; i < 50; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = `${Math.random() * 100}%`;
            p.style.top  = `${Math.random() * 100}%`;
            p.style.animationDelay = `${Math.random() * 15}s`;
            p.style.opacity = Math.random() * 0.3;
            container.appendChild(p);
        }
    }

    /* -- Neural canvas animation -- */
    function initializeNeuralCanvas() {
        const canvas = document.getElementById('neuralCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let nodes = [];
        let animFrame;

        function resize() {
            canvas.width  = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        for (let i = 0; i < 40; i++) {
            nodes.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 0.5,
                vy: (Math.random() - 0.5) * 0.5,
                r: Math.random() * 2 + 1
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            nodes.forEach(n => {
                n.x += n.vx; n.y += n.vy;
                if (n.x < 0 || n.x > canvas.width)  n.vx *= -1;
                if (n.y < 0 || n.y > canvas.height) n.vy *= -1;
                ctx.beginPath();
                ctx.arc(n.x, n.y, n.r, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(0,243,255,0.6)';
                ctx.fill();
            });
            nodes.forEach((a, i) => {
                nodes.forEach((b, j) => {
                    if (j <= i) return;
                    const dist = Math.hypot(a.x - b.x, a.y - b.y);
                    if (dist < 130) {
                        ctx.beginPath();
                        ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y);
                        ctx.strokeStyle = `rgba(0,243,255,${0.15 * (1 - dist / 130)})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                    }
                });
            });
            animFrame = requestAnimationFrame(draw);
        }
        draw();
    }

    /* -- Typewriter effect -- */
    function initializeTypewriter() {
        const phrases = [
            'Real-time AI processing · Enterprise-grade security',
            'Up to date information · Multiple AI models',
            'File attachments · Unlimited conversation history',
            'Powered by state-of-the-art Llama models'
        ];
        let phraseIndex = 0, charIndex = 0, deleting = false;
        const el = document.getElementById('typewriterText');
        if (!el) return;

        function type() {
            const phrase = phrases[phraseIndex];
            if (!deleting) {
                el.textContent = phrase.substring(0, charIndex + 1);
                charIndex++;
                if (charIndex === phrase.length) {
                    deleting = true;
                    setTimeout(type, 2200);
                    return;
                }
            } else {
                el.textContent = phrase.substring(0, charIndex - 1);
                charIndex--;
                if (charIndex === 0) {
                    deleting = false;
                    phraseIndex = (phraseIndex + 1) % phrases.length;
                }
            }
            setTimeout(type, deleting ? 30 : 45);
        }
        setTimeout(type, 800);
    }

    /* ================================================================
       AUTH
    ================================================================ */
    function initializeAuth() {
        // Listen for future auth state changes (email sign-in, sign-out, etc.)
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                handleUserSignedIn(session.user);
            } else if (event === 'SIGNED_OUT') {
                handleUserSignedOut();
            }
        });

        // ── CRITICAL: Check for an existing session RIGHT NOW ──
        // When Supabase redirects back from Google/GitHub/Discord/Microsoft,
        // the access_token is in the URL hash. The client parses it on creation
        // but the onAuthStateChange event may fire before the listener above is
        // registered. getSession() is the reliable fallback that catches it.
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                handleUserSignedIn(session.user);
            }
            // If no session, showAuth() in DOMContentLoaded will handle it
        });
    }

    function setupEventListeners() {
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('chatInput').addEventListener('input', updateCharacterCount);
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') { closeAllModals(); closeFilePreview(); }
        });
    }

    function initializeFileDropZone() {
        const dropZone  = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const prevent   = e => { e.preventDefault(); e.stopPropagation(); };
        ['dragenter','dragover','dragleave','drop'].forEach(ev => {
            dropZone.addEventListener(ev, prevent, false);
            document.body.addEventListener(ev, prevent, false);
        });
        ['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, () => {
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.background  = 'rgba(0,243,255,0.08)';
        }));
        ['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, () => {
            dropZone.style.borderColor = 'rgba(0,243,255,0.25)';
            dropZone.style.background  = '';
        }));
        dropZone.addEventListener('drop', e => handleFileSelect({ target: { files: e.dataTransfer.files } }));
        dropZone.addEventListener('click', () => fileInput.click());
    }

    function handleUserSignedIn(user) {
        const name = user.user_metadata?.full_name
                  || user.user_metadata?.name
                  || user.email?.split('@')[0]
                  || 'User';
        currentUser = {
            id:        user.id,
            name,
            email:     user.email,
            avatar:    getAvatarInitials(name),
            avatarUrl: user.user_metadata?.avatar_url
                    || user.user_metadata?.picture
                    || null
        };
        updateUserUI();
        loadUserSettings();
        loadChatHistory();
        showChat();
        showToast(`Welcome back, ${name.split(' ')[0]}!`, 'success');
    }

    function handleUserSignedOut() {
        currentUser = null;
        attachedFiles = []; selectedFiles = [];
        showAuth();
    }

    function showAuth() {
        // Strip OAuth tokens from the URL hash — they've already been consumed
        // by the Supabase client. Leaving them visible is a security/UX issue.
        if (window.location.hash.includes('access_token')) {
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
        }
        document.getElementById('chatContainer').classList.remove('active');
        document.getElementById('authContainer').style.display = 'flex';
    }

    function showChat() {
        // Clean OAuth tokens from URL on successful login
        if (window.location.hash.includes('access_token')) {
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
        }
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('chatContainer').classList.add('active');
    }

    function updateUserUI() {
        if (!currentUser) return;
        document.getElementById('userName').textContent  = currentUser.name;
        document.getElementById('userEmail').textContent = currentUser.email;
        const avatarEl = document.getElementById('userAvatar');
        if (currentUser.avatarUrl) {
            avatarEl.innerHTML = `<img src="${currentUser.avatarUrl}" alt="${currentUser.name}" onerror="this.parentElement.innerHTML='${currentUser.avatar}'">`;
        } else {
            avatarEl.textContent = currentUser.avatar;
        }
    }

    /* ── FIX 1: switchAuthTab now properly updates button active classes ── */
    function switchAuthTab(tab) {
        const signinForm = document.getElementById('signinForm');
        const signupForm = document.getElementById('signupForm');
        const indicator  = document.getElementById('tabIndicator');
        const signinTab  = document.getElementById('signinTab');
        const signupTab  = document.getElementById('signupTab');

        if (tab === 'signin') {
            signinForm.style.display = 'block';
            signupForm.style.display = 'none';
            signinForm.style.animation = 'formAppear 0.3s ease-out both';
            indicator.classList.remove('signup');
            signinTab.classList.add('active');
            signupTab.classList.remove('active');
            document.getElementById('formHeaderTitle').textContent = 'NEURAL ACCESS';
            document.getElementById('formHeaderSub').textContent   = '// authenticate to continue_';
        } else {
            signinForm.style.display = 'none';
            signupForm.style.display = 'block';
            signupForm.style.animation = 'formAppear 0.3s ease-out both';
            indicator.classList.add('signup');
            signupTab.classList.add('active');
            signinTab.classList.remove('active');
            document.getElementById('formHeaderTitle').textContent = 'CREATE ACCOUNT';
            document.getElementById('formHeaderSub').textContent   = '// initialize new profile_';
        }
    }

    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon  = input.parentElement.querySelector('.password-toggle i');
        input.type  = input.type === 'password' ? 'text' : 'password';
        icon.classList.toggle('fa-eye', input.type === 'password');
        icon.classList.toggle('fa-eye-slash', input.type === 'text');
    }

    /* ── Loading state helpers ── */
    function setButtonLoading(btnId, loading) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        btn.disabled = loading;
        btn.classList.toggle('loading', loading);
    }

    async function signInWithEmail() {
        if (!supabaseClient) { showToast('Auth not ready — please refresh the page.', 'error'); return; }
        const email    = document.getElementById('signinEmail').value.trim();
        const password = document.getElementById('signinPassword').value;

        if (!validateEmail(email))  { showToast('Please enter a valid email address', 'error'); return; }
        if (!password)              { showToast('Please enter your password', 'error'); return; }

        setButtonLoading('signinBtn', true);
        try {
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
        } catch (error) {
            console.error('Sign in error:', error);
            showToast(getAuthError(error), 'error');
        } finally {
            setButtonLoading('signinBtn', false);
        }
    }

    async function signUpWithEmail() {
        if (!supabaseClient) { showToast('Auth not ready — please refresh the page.', 'error'); return; }
        const name            = document.getElementById('signupName').value.trim();
        const email           = document.getElementById('signupEmail').value.trim();
        const password        = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('signupConfirmPassword').value;
        const acceptTerms     = document.getElementById('acceptTerms').checked;

        if (!name)                    { showToast('Please enter your name', 'error'); return; }
        if (!validateEmail(email))    { showToast('Please enter a valid email address', 'error'); return; }
        if (password.length < 6)      { showToast('Password must be at least 6 characters', 'error'); return; }
        if (password !== confirmPassword) { showToast('Passwords do not match', 'error'); return; }
        if (!acceptTerms)             { showToast('Please accept the terms and conditions', 'error'); return; }

        setButtonLoading('signupBtn', true);
        try {
            const { data, error } = await supabaseClient.auth.signUp({
                email, password,
                options: { data: { full_name: name } }
            });
            if (error) throw error;
            if (data.user) {
                try {
                    await supabaseClient.from('users').insert({
                        id: data.user.id, name, email,
                        avatar: getAvatarInitials(name),
                        created_at: new Date().toISOString(),
                        settings: { aiModel: 'cyanix-pro' }
                    });
                } catch (dbErr) {
                    console.warn('Could not create user record:', dbErr.message);
                }
            }
            showToast('Account created! Please check your email for confirmation.', 'success');
        } catch (error) {
            console.error('Sign up error:', error);
            showToast(getAuthError(error), 'error');
        } finally {
            setButtonLoading('signupBtn', false);
        }
    }

    async function signInWithGoogle() {
        if (!supabaseClient) { showToast('Auth not ready — please refresh the page.', 'error'); return; }
        try {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.href.split('#')[0] }
            });
            if (error) throw error;
        } catch (error) { showToast(getAuthError(error), 'error'); }
    }

    async function signInWithMicrosoft() {
        if (!supabaseClient) { showToast('Auth not ready — please refresh the page.', 'error'); return; }
        try {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'azure',
                options: { redirectTo: window.location.href.split('#')[0] }
            });
            if (error) throw error;
        } catch (error) { showToast(getAuthError(error), 'error'); }
    }

    async function signInWithGithub() {
        if (!supabaseClient) { showToast('Auth not ready — please refresh the page.', 'error'); return; }
        try {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'github',
                options: { redirectTo: window.location.href.split('#')[0] }
            });
            if (error) throw error;
        } catch (error) { showToast(getAuthError(error), 'error'); }
    }

    async function signInWithDiscord() {
        if (!supabaseClient) { showToast('Auth not ready — please refresh the page.', 'error'); return; }
        try {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'discord',
                options: { redirectTo: window.location.href.split('#')[0] }
            });
            if (error) throw error;
        } catch (error) { showToast(getAuthError(error), 'error'); }
    }

    function signUpWithGoogle()    { signInWithGoogle(); }
    function signUpWithMicrosoft() { signInWithMicrosoft(); }
    function signUpWithGithub()    { signInWithGithub(); }
    function signUpWithDiscord()   { signInWithDiscord(); }

    async function forgotPassword() {
        const email = prompt('Enter your email address to reset password:');
        if (email && validateEmail(email)) {
            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href.split('#')[0]
                });
                if (error) throw error;
                showToast('Password reset email sent! Check your inbox.', 'success');
            } catch (error) { showToast(getAuthError(error), 'error'); }
        }
    }

    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function getAuthError(error) {
        const map = {
            'Invalid login credentials':               'Invalid email or password',
            'Email not confirmed':                     'Please confirm your email address',
            'User already registered':                 'Email already in use',
            'Password should be at least 6 characters':'Password is too weak'
        };
        return map[error.message] || error.message || 'Authentication failed';
    }

    /* ================================================================
       FILE HANDLING
    ================================================================ */
    function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            if (!selectedFiles.some(f => f.name === file.name && f.size === file.size))
                selectedFiles.push(file);
        });
        updateSelectedFilesDisplay();
    }

    function updateSelectedFilesDisplay() {
        const container        = document.getElementById('selectedFiles');
        const previewContainer = document.getElementById('selectedFilesPreview');
        container.innerHTML = '';
        if (selectedFiles.length === 0) {
            container.innerHTML = '<div style="color:var(--text-secondary); text-align:center; padding:20px; font-size:13px; font-family:\'JetBrains Mono\',monospace;">No files selected</div>';
            previewContainer.style.display = 'none';
            return;
        }
        selectedFiles.forEach((file, index) => {
            const el = document.createElement('div');
            el.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:10px; background:rgba(0,243,255,0.05); border-radius:8px; margin-bottom:8px;';
            el.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px; flex:1;">
                    ${getFileIcon(file.type, file.name)}
                    <div style="flex:1; min-width:0;">
                        <div style="color:var(--text); font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${file.name}</div>
                        <div style="color:var(--text-secondary); font-size:11px; font-family:'JetBrains Mono',monospace;">${formatFileSize(file.size)}</div>
                    </div>
                </div>
                <button onclick="removeSelectedFile(${index})" style="background:none; border:none; color:var(--error); cursor:pointer; padding:5px; margin-left:10px;"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(el);
        });
        updateSelectedFilesPreview();
    }

    function updateSelectedFilesPreview() {
        const preview = document.getElementById('selectedFilesPreview');
        preview.innerHTML = '';
        if (selectedFiles.length === 0) { preview.style.display = 'none'; return; }
        preview.style.display = 'flex';
        selectedFiles.forEach((file, index) => {
            const el = document.createElement('div');
            el.className = 'selected-file';
            el.innerHTML = `
                ${getFileIcon(file.type, file.name, true)}
                <div class="selected-file-info">
                    <div class="selected-file-name">${file.name}</div>
                    <div class="selected-file-size">${formatFileSize(file.size)}</div>
                </div>
                <button class="selected-file-remove" onclick="removeSelectedFile(${index})"><i class="fas fa-times"></i></button>
            `;
            preview.appendChild(el);
        });
    }

    function removeSelectedFile(index) {
        selectedFiles.splice(index, 1);
        updateSelectedFilesDisplay();
    }

    function getFileIcon(type, name, small = false) {
        const sz = small ? '12px' : '18px';
        if (type.startsWith('image/')) return `<i class="fas fa-image" style="color:var(--primary); font-size:${sz};"></i>`;
        if (type === 'application/pdf' || name.endsWith('.pdf')) return `<i class="fas fa-file-pdf" style="color:#FF6B6B; font-size:${sz};"></i>`;
        if (type.includes('word') || name.endsWith('.doc') || name.endsWith('.docx')) return `<i class="fas fa-file-word" style="color:#2B579A; font-size:${sz};"></i>`;
        if (type.includes('excel') || name.endsWith('.xls') || name.endsWith('.xlsx')) return `<i class="fas fa-file-excel" style="color:#217346; font-size:${sz};"></i>`;
        if (type.includes('powerpoint') || name.endsWith('.ppt') || name.endsWith('.pptx')) return `<i class="fas fa-file-powerpoint" style="color:#D24726; font-size:${sz};"></i>`;
        if (type.includes('zip') || name.endsWith('.zip') || name.endsWith('.rar') || name.endsWith('.7z')) return `<i class="fas fa-file-archive" style="color:#FFA500; font-size:${sz};"></i>`;
        if (type.includes('text') || ['.txt','.md','.rtf'].some(e => name.endsWith(e))) return `<i class="fas fa-file-alt" style="color:var(--primary); font-size:${sz};"></i>`;
        if (['.js','.py','.html','.css','.json','.xml'].some(e => name.endsWith(e))) return `<i class="fas fa-file-code" style="color:var(--accent); font-size:${sz};"></i>`;
        if (type.startsWith('audio/')) return `<i class="fas fa-file-audio" style="color:#00ff88; font-size:${sz};"></i>`;
        if (type.startsWith('video/')) return `<i class="fas fa-file-video" style="color:#ff4757; font-size:${sz};"></i>`;
        return `<i class="fas fa-file" style="color:var(--text-secondary); font-size:${sz};"></i>`;
    }

    function formatFileSize(bytes) {
        if (!bytes) return '0 Bytes';
        const k = 1024, sizes = ['Bytes','KB','MB','GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function uploadFiles() {
        if (!selectedFiles.length) { showToast('No files selected', 'warning'); return; }
        if (!currentUser)          { showToast('Please sign in to upload files', 'error'); return; }

        const progressContainer = document.getElementById('uploadProgress');
        const progressBar       = document.getElementById('uploadProgressBar');
        const progressPct       = document.getElementById('uploadPercentage');
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressPct.textContent = '0%';

        const uploaded = [];
        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            try {
                const ts     = Date.now();
                const rand   = Math.random().toString(36).substring(2, 15);
                const path   = `${currentUser.id}/${ts}_${rand}_${file.name}`;
                const { error } = await supabaseClient.storage.from('attachments').upload(path, file, { cacheControl:'3600', upsert:false });
                if (error) throw error;
                const { data: urlData } = supabaseClient.storage.from('attachments').getPublicUrl(path);
                uploaded.push({ name: file.name, type: file.type, size: file.size, url: urlData.publicUrl, storagePath: path, uploadedAt: new Date().toISOString() });
                const pct = ((i + 1) / selectedFiles.length) * 100;
                progressBar.style.width = pct + '%';
                progressPct.textContent = Math.round(pct) + '%';
            } catch (error) {
                showToast(`Error uploading ${file.name}: ${error.message}`, 'error');
            }
        }
        selectedFiles = [];
        updateSelectedFilesDisplay();
        progressContainer.style.display = 'none';
        attachedFiles.push(...uploaded);
        closeFileModal();
        if (uploaded.length) showToast(`Uploaded ${uploaded.length} file(s)`, 'success');
    }

    /* ================================================================
       FILE PREVIEW
    ================================================================ */
    function openFilePreview(file) {
        const modal  = document.getElementById('filePreviewModal');
        const image  = document.getElementById('previewImage');
        const iframe = document.getElementById('previewIframe');
        const text   = document.getElementById('previewText');
        image.style.display = 'none'; iframe.style.display = 'none'; text.style.display = 'none';
        window.previewFile = file;

        if (file.type.startsWith('image/')) {
            image.src = file.url; image.style.display = 'block';
        } else if (file.type === 'application/pdf') {
            iframe.src = file.url; iframe.style.display = 'block';
        } else if (file.type.startsWith('text/') || ['.txt','.md','.json','.js','.py','.html','.css'].some(e => file.name.endsWith(e))) {
            fetch(file.url).then(r => r.text()).then(c => { text.textContent = c; text.style.display = 'block'; }).catch(() => showToast('Error loading file', 'error'));
        } else {
            downloadFile(file); return;
        }
        modal.classList.add('active');
    }

    function closeFilePreview() { document.getElementById('filePreviewModal').classList.remove('active'); }
    function downloadPreviewFile() { if (window.previewFile) downloadFile(window.previewFile); }
    function downloadFile(file) {
        const a = document.createElement('a');
        a.href = file.url; a.download = file.name; a.target = '_blank';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    /* ================================================================
       CHAT FUNCTIONS
    ================================================================ */

    /* ── FIX 3: Use <template> so welcome screen is always clonable ── */
    function renderWelcomeScreen() {
        const wrapper  = document.getElementById('messagesWrapper');
        const template = document.getElementById('welcomeScreenTemplate');
        wrapper.innerHTML = '';
        wrapper.appendChild(template.content.cloneNode(true));
    }

    function newChat() {
        currentChatId = null;
        conversationHistory = [];
        attachedFiles = []; selectedFiles = [];
        renderWelcomeScreen();
        document.getElementById('chatTitle').textContent = 'New Chat';
        document.getElementById('selectedFilesPreview').style.display = 'none';
        // Deselect all history items
        document.querySelectorAll('.chat-history-item').forEach(el => el.classList.remove('active'));
        if (window.innerWidth <= 768) toggleSidebar();
        showToast('New chat started', 'info');
    }

    function useExample(type) {
        const examples = {
            brainstorm: 'Help me brainstorm creative project ideas for a tech startup that combines AI with environmental sustainability.',
            explain:    'Explain quantum computing in simple terms. How does it differ from classical computing, and what are its potential applications?',
            code:       'Write a Python function to sort a list using quicksort algorithm. Include comments explaining each step and provide example usage.',
            analyze:    'Analyze the pros and cons of renewable energy sources (solar, wind, hydro) compared to fossil fuels. Consider factors like cost, efficiency, and environmental impact.'
        };
        const input = document.getElementById('chatInput');
        input.value = examples[type];
        autoResize(input);
        updateCharacterCount();
        input.focus();
    }

    async function sendMessage() {
        const input   = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message && !attachedFiles.length && !selectedFiles.length) {
            showToast('Please enter a message or attach files', 'warning');
            return;
        }
        if (message.length > 2000) { showToast('Message too long (max 2000 characters)', 'error'); return; }

        // Remove welcome screen if visible
        const ws = document.querySelector('.welcome-screen');
        if (ws) ws.remove();

        if (selectedFiles.length > 0) {
            showToast('Uploading files...', 'info');
            await uploadFiles();
        }

        const filesToSend = [...attachedFiles];
        addMessage(message, 'user', filesToSend);
        input.value = '';
        attachedFiles = []; selectedFiles = [];
        updateSelectedFilesDisplay();
        document.getElementById('selectedFilesPreview').style.display = 'none';
        autoResize(input);
        updateCharacterCount();
        showTypingIndicator();

        if (!currentChatId) {
            try {
                currentChatId = await createChat(message || 'File upload');
                const chatLabel = (message || 'File upload').substring(0, 30) + ((message || 'File upload').length > 30 ? '...' : '');
                document.getElementById('chatTitle').textContent = chatLabel;
                loadChatHistory(); // refresh sidebar
            } catch (e) { console.warn('Could not create chat record:', e.message); }
        }

        try {
            // Create the AI message bubble immediately, stream tokens into it
            hideTypingIndicator();
            const assistantDiv = createStreamingMessageBubble();
            const aiResponse   = await streamAIResponse(message, filesToSend, assistantDiv);
            conversationHistory.push({ role: 'user', content: message, files: filesToSend.map(f => ({ name: f.name, type: f.type, url: f.url })) });
            conversationHistory.push({ role: 'assistant', content: aiResponse });
            await saveMessage(message, 'user', filesToSend);
            await saveMessage(aiResponse, 'assistant');
        } catch (error) {
            console.error('Error getting AI response:', error);
            hideTypingIndicator();
            showToast('Error getting response from AI', 'error');
            addMessage('I encountered an error processing your request. Please try again.', 'assistant');
        }
    }

    function addMessage(content, sender, files = []) {
        const wrapper = document.getElementById('messagesWrapper');
        const div     = document.createElement('div');
        div.className = `message ${sender}`;

        const time   = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const name   = sender === 'user' ? (currentUser?.name  || 'You') : 'Cyanix AI';
        // Use OAuth photo for user if available, else initials; always use gradient icon for AI
        const avatarHTML = sender === 'user'
            ? (currentUser?.avatarUrl
                ? `<img src="${currentUser.avatarUrl}" alt="${currentUser.name}" onerror="this.parentElement.textContent='${currentUser?.avatar||'U'}';">`
                : (currentUser?.avatar || 'U'))
            : '<i class="fas fa-robot" style="font-size:13px;"></i>';

        let attachHTML = '';
        if (files && files.length) {
            attachHTML = '<div class="attachments-container">';
            files.forEach(file => {
                const fs = JSON.stringify(file).replace(/"/g, '&quot;');
                attachHTML += `
                    <div class="attachment-item" onclick='openFilePreview(${fs})'>
                        <div class="attachment-actions">
                            <button class="attachment-action" onclick="event.stopPropagation(); downloadFile(${fs})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                        <div class="attachment-preview">
                            ${file.type.startsWith('image/') ? `<img src="${file.url}" alt="${file.name}" loading="lazy">` : ''}
                            <div class="attachment-icon" ${file.type.startsWith('image/') ? 'style="display:none;"' : ''}>
                                ${getFileIcon(file.type, file.name)}
                            </div>
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name">${file.name}</div>
                            <div class="attachment-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>`;
            });
            attachHTML += '</div>';
        }

        div.innerHTML = `
            <div class="message-bubble">
                <div class="message-header">
                    <div class="message-avatar">${avatarHTML}</div>
                    <div class="message-sender">${name}</div>
                    <div class="message-time">${time}</div>
                </div>
                ${attachHTML}
                <div class="message-content">${formatMessage(content)}</div>
            </div>`;

        wrapper.appendChild(div);
        scrollToBottom();
    }

    function formatMessage(content) {
        return content ? marked.parse(content) : '';
    }

    function showTypingIndicator() {
        const wrapper = document.getElementById('messagesWrapper');
        const div     = document.createElement('div');
        div.className = 'typing-indicator'; div.id = 'typingIndicator';
        div.innerHTML = `
            <div class="message-avatar" style="background:linear-gradient(135deg,var(--accent),#9d4edd); color:var(--text); width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; flex-shrink:0;">AI</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>`;
        wrapper.appendChild(div);
        scrollToBottom();
    }

    function hideTypingIndicator() {
        const el = document.getElementById('typingIndicator');
        if (el) el.remove();
    }

    /* ── FIX 2: Correct element ID for scroll ── */
    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        if (container) container.scrollTop = container.scrollHeight;
    }

    /* ================================================================
       AI RESPONSE — STREAMING
    ================================================================ */

    /** Creates the AI message bubble in the DOM and returns it ready for streaming */
    function createStreamingMessageBubble() {
        const wrapper = document.getElementById('messagesWrapper');
        const div     = document.createElement('div');
        div.className = 'message assistant';
        div.id        = 'streamingMessage';
        const time    = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        div.innerHTML = `
            <div class="message-bubble">
                <div class="message-header">
                    <div class="message-avatar">
                        <i class="fas fa-robot" style="font-size:13px;"></i>
                    </div>
                    <div class="message-sender">Cyanix AI</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content streaming" id="streamingContent"></div>
            </div>`;
        wrapper.appendChild(div);
        scrollToBottom();
        return div;
    }

    /** Streams tokens from the edge function into the message bubble */
    async function streamAIResponse(message, files = [], bubbleDiv) {
        const contentEl = bubbleDiv.querySelector('#streamingContent');
        let fullContent = '';

        try {
            // Build message history
            const messages = conversationHistory.slice(-10).map(m => ({
                role:    m.role === 'user' ? 'user' : 'assistant',
                content: m.content
            }));

            let userContent = message;
            if (files.length) {
                userContent += '\n\nAttached files:';
                files.forEach(f => {
                    userContent += `\n- ${f.name} (${f.type}, ${formatFileSize(f.size)})`;
                    if (f.type.startsWith('image/') && currentModel === 'cyanix-vision')
                        userContent += ` [Image URL: ${f.url}]`;
                });
            }
            messages.push({ role: 'user', content: userContent });

            const response = await fetch(SUPABASE_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type':  'application/json',
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                },
                body: JSON.stringify({
                    messages,
                    model:       MODEL_MAP[currentModel],
                    temperature: 0.7,
                    max_tokens:  1500,
                    stream:      true
                })
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`Edge function error (${response.status}): ${errText}`);
            }

            // Read SSE stream
            const reader  = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line.startsWith('data: ')) continue;
                    const data = line.slice(6).trim();
                    if (data === '[DONE]') break;
                    try {
                        const parsed = JSON.parse(data);
                        const delta  = parsed.choices?.[0]?.delta?.content ?? '';
                        if (delta) {
                            fullContent += delta;
                            contentEl.innerHTML = formatMessage(fullContent);
                            scrollToBottom();
                        }
                    } catch { /* partial chunk — skip */ }
                }
            }

        } catch (error) {
            console.error('Stream error:', error);
            fullContent = `I encountered an error while processing your request. Please try again. (${error.message})`;
        }

        // Done streaming — remove cursor, render final markdown
        contentEl.classList.remove('streaming');
        contentEl.removeAttribute('id');
        bubbleDiv.removeAttribute('id');
        if (fullContent) {
            contentEl.innerHTML = formatMessage(fullContent);
        }
        scrollToBottom();
        return fullContent;
    }

    /* ================================================================
       MODEL MANAGEMENT
    ================================================================ */
    function openModelModal()  { document.getElementById('modelModal').classList.add('active'); }
    function closeModelModal() { document.getElementById('modelModal').classList.remove('active'); }

    function selectModel(model) {
        currentModel = model;
        document.querySelectorAll('.model-card').forEach(c => c.classList.toggle('active', c.dataset.model === model));
        const names = { 'cyanix-pro':'Axion', 'cyanix-flash':'Cyanix', 'cyanix-vision':'Synix', 'cyanix-advanced':'Nebula' };
        document.getElementById('currentModel').textContent = names[model];
    }

    async function saveModelSelection() {
        if (currentUser) {
            try {
                const { error } = await supabaseClient.from('users')
                    .update({ settings: { aiModel: currentModel }, updated_at: new Date().toISOString() })
                    .eq('id', currentUser.id);
                if (error) throw error;
                showToast('AI model updated!', 'success');
            } catch (error) { showToast('Error saving model selection', 'error'); }
        }
        closeModelModal();
    }

    async function loadUserSettings() {
        if (!currentUser) return;
        try {
            const { data, error } = await supabaseClient.from('users').select('settings').eq('id', currentUser.id).single();
            if (error && error.code !== 'PGRST116') throw error;
            if (data?.settings?.aiModel) { currentModel = data.settings.aiModel; selectModel(currentModel); }
        } catch (error) { console.error('Error loading user settings:', error); }
    }

    function openFileModal()  { document.getElementById('fileModal').classList.add('active'); }
    function closeFileModal() { document.getElementById('fileModal').classList.remove('active'); }

    /* ================================================================
       CHAT HISTORY PERSISTENCE
    ================================================================ */
    async function loadChatHistory() {
        if (!currentUser) return;
        const historyEl = document.getElementById('chatHistory');
        historyEl.innerHTML = '<div style="padding:12px 8px; text-align:center; color:var(--text-secondary); font-size:11px; font-family:monospace;">Loading...</div>';
        try {
            const { data: chats, error } = await supabaseClient
                .from('chats')
                .select('id, title, updated_at, last_message')
                .eq('user_id', currentUser.id)
                .order('updated_at', { ascending: false })
                .limit(30);

            if (error) throw error;

            historyEl.innerHTML = '';
            if (!chats || chats.length === 0) {
                historyEl.innerHTML = '<div class="chat-history-empty">No chats yet.<br>Start a conversation!</div>';
                return;
            }

            chats.forEach(chat => {
                const isActive = chat.id === currentChatId;
                const item = document.createElement('div');
                item.className = `chat-history-item${isActive ? ' active' : ''}`;
                item.dataset.chatId = chat.id;
                const title = chat.title || 'Untitled Chat';
                item.innerHTML = `
                    <i class="fas fa-comment chat-history-icon"></i>
                    <span class="chat-history-text" title="${title}">${title}</span>
                    <button class="delete-chat-btn" onclick="event.stopPropagation(); deleteChatRecord('${chat.id}')" title="Delete chat">
                        <i class="fas fa-times"></i>
                    </button>`;
                item.addEventListener('click', () => openChat(chat.id, chat.title));
                historyEl.appendChild(item);
            });
        } catch (e) {
            console.error('loadChatHistory error:', e);
            historyEl.innerHTML = '<div class="chat-history-empty">Could not load history.</div>';
        }
    }

    async function openChat(chatId, title) {
        if (chatId === currentChatId) return;
        currentChatId = chatId;

        // Highlight active item
        document.querySelectorAll('.chat-history-item').forEach(el => {
            el.classList.toggle('active', el.dataset.chatId === chatId);
        });

        document.getElementById('chatTitle').textContent = (title || 'Chat').substring(0, 30);
        conversationHistory = [];

        // Clear messages, show loading
        const wrapper = document.getElementById('messagesWrapper');
        wrapper.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-secondary); font-family:monospace; font-size:12px;">Loading messages...</div>';

        try {
            const { data: msgs, error } = await supabaseClient
                .from('messages')
                .select('id, content, sender, timestamp, files')
                .eq('chat_id', chatId)
                .order('timestamp', { ascending: true });

            if (error) throw error;

            wrapper.innerHTML = '';
            if (!msgs || msgs.length === 0) {
                renderWelcomeScreen();
                return;
            }

            msgs.forEach(msg => {
                addMessage(msg.content, msg.sender, msg.files || []);
                conversationHistory.push({ role: msg.sender, content: msg.content });
            });
        } catch (e) {
            console.error('openChat error:', e);
            wrapper.innerHTML = '';
            renderWelcomeScreen();
            showToast('Could not load chat messages.', 'error');
        }

        if (window.innerWidth <= 768) toggleSidebar();
    }

    async function deleteChatRecord(chatId) {
        if (!confirm('Delete this chat? This cannot be undone.')) return;
        try {
            await supabaseClient.from('messages').delete().eq('chat_id', chatId);
            await supabaseClient.from('chats').delete().eq('id', chatId);
            if (chatId === currentChatId) {
                currentChatId = null;
                conversationHistory = [];
                renderWelcomeScreen();
                document.getElementById('chatTitle').textContent = 'New Chat';
            }
            loadChatHistory();
            showToast('Chat deleted.', 'info');
        } catch (e) {
            console.error('deleteChatRecord error:', e);
            showToast('Could not delete chat.', 'error');
        }
    }

    /* ================================================================
       DATABASE
    ================================================================ */
    async function createChat(firstMessage) {
        const { data, error } = await supabaseClient.from('chats').insert({
            user_id: currentUser.id,
            title: firstMessage.substring(0, 50) + (firstMessage.length > 50 ? '...' : ''),
            model: currentModel,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            has_files: attachedFiles.length > 0
        }).select('id').single();
        if (error) throw error;
        return data.id;
    }

    async function saveMessage(content, sender, files = []) {
        if (!currentChatId || !currentUser) return;
        try {
            const msgData = {
                chat_id: currentChatId,
                user_id: currentUser.id,
                content, sender,
                timestamp: new Date().toISOString()
            };
            if (files && files.length) {
                msgData.files = files.map(f => ({ name: f.name, type: f.type, size: f.size, url: f.url, storagePath: f.storagePath }));
            }
            await supabaseClient.from('messages').insert(msgData);
            await supabaseClient.from('chats').update({
                updated_at: new Date().toISOString(),
                last_message: content.substring(0, 100) + (content.length > 100 ? '...' : '')
            }).eq('id', currentChatId);
        } catch (error) { console.error('Error saving message:', error); }
    }

    /* ================================================================
       UTILITIES
    ================================================================ */
    function getAvatarInitials(name) {
        if (!name) return 'U';
        const parts = name.split(' ');
        return parts.length > 1 ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase();
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast     = document.createElement('div');
        toast.className = `toast ${type}`;
        const icons = { success:'fa-check-circle', error:'fa-exclamation-circle', warning:'fa-exclamation-triangle', info:'fa-info-circle' };
        toast.innerHTML = `
            <i class="fas ${icons[type] || icons.info} toast-icon"></i>
            <div class="toast-content"><div class="toast-message">${message}</div></div>
            <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>`;
        container.appendChild(toast);
        setTimeout(() => { if (toast.parentElement) toast.style.animation = 'toastSlide 0.3s reverse forwards'; setTimeout(() => toast.remove(), 300); }, 5000);
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }

    function updateCharacterCount() {
        const input  = document.getElementById('chatInput');
        const count  = document.getElementById('charCount');
        const length = input.value.length;
        count.textContent = `${length}/2000`;
        count.style.color = length > 1800 ? 'var(--error)' : length > 1500 ? 'var(--warning)' : 'var(--text-secondary)';
    }

    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function toggleSidebar()  { document.getElementById('sidebar').classList.toggle('active'); }
    function toggleUserMenu() { showToast('User menu coming soon!', 'info'); }

    function clearChat() {
        if (confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
            conversationHistory = []; attachedFiles = []; selectedFiles = [];
            renderWelcomeScreen();
            document.getElementById('selectedFilesPreview').style.display = 'none';
            showToast('Chat cleared', 'info');
        }
    }

    function closeAllModals() {
        document.getElementById('modelModal').classList.remove('active');
        document.getElementById('fileModal').classList.remove('active');
    }
    </script>
</body>
</html>
